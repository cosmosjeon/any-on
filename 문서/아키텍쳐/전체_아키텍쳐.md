# Anyon 전체 아키텍쳐 문서

**프로젝트:** Anyon
**버전:** 0.0.116
**타입:** AI 코딩 에이전트 오케스트레이션 플랫폼
**아키텍쳐:** Rust 백엔드 + React 프론트엔드 Monorepo
**작성일:** 2025-01-08

---

## 목차

1. [개요 및 시스템 목적](#1-개요-및-시스템-목적)
2. [핵심 기술 스택](#2-핵심-기술-스택)
3. [시스템 아키텍쳐 다이어그램](#3-시스템-아키텍쳐-다이어그램)
4. [프로젝트 구조](#4-프로젝트-구조)
5. [핵심 아키텍쳐 패턴](#5-핵심-아키텍쳐-패턴)
6. [주요 서브시스템](#6-주요-서브시스템)
7. [데이터 아키텍쳐](#7-데이터-아키텍쳐)
8. [통합 포인트](#8-통합-포인트)
9. [개발 워크플로우](#9-개발-워크플로우)
10. [필수 개발 규칙](#10-필수-개발-규칙)
11. [아키텍쳐 의사결정 근거](#11-아키텍쳐-의사결정-근거)
12. [성능 고려사항](#12-성능-고려사항)
13. [보안 고려사항](#13-보안-고려사항)
14. [부록: 주요 통계](#14-부록-주요-통계)

---

## 1. 개요 및 시스템 목적

### 1.1 시스템 개요

Anyon은 **다중 AI 코딩 에이전트를 관리하고 조율하는 풀스택 플랫폼**입니다. 개발자들이 Claude Code, Gemini, Copilot, Cursor 등 **9개의 서로 다른 AI 코딩 에이전트**를 하나의 통합된 인터페이스를 통해 활용할 수 있게 해줍니다.

**핵심 가치 제안:**
- ✅ 여러 AI 에이전트를 하나의 작업에 순차적/병렬적으로 실행
- ✅ 실시간 로그 스트리밍과 코드 변경 사항 모니터링
- ✅ Git 워크트리 격리를 통한 안전한 병렬 실행
- ✅ GitHub PR 자동 생성 및 관리
- ✅ MCP(Model Context Protocol) 서버로서 AI 에이전트와 통신

### 1.2 주요 기능

#### **1.2.1 작업 관리 (Task Management)**
- 프로젝트별 작업 생성 및 추적
- 작업 상태 관리 (todo → inprogress → inreview → done)
- 작업 간 부모-자식 관계 지원
- 태그를 통한 작업 분류

#### **1.2.2 AI 에이전트 실행 (Agent Orchestration)**
- **9개 에이전트 지원**: Claude Code, Gemini, Copilot, Cursor, AMP, OpenCode, Qwen, Codex, Cursor Agent
- 작업당 여러 시도(attempts) 실행 가능
- 에이전트별 프로파일 설정 (MCP 서버, 환경 변수, 커맨드 오버라이드)
- 실행 중/실패/성공 상태 실시간 추적

#### **1.2.3 실시간 모니터링 (Real-Time Monitoring)**
- **Server-Sent Events (SSE)**를 통한 로그 스트리밍
- **WebSocket JSON Patch** 프로토콜로 UI 상태 동기화
- 파일 변경 사항(diff) 실시간 업데이트
- 프로세스 상태 변화 즉시 반영

#### **1.2.4 Git 통합 (Git Integration)**
- **Worktree 격리**: 각 작업 시도마다 독립된 Git 워크트리 생성
- 자동 브랜치 생성 및 관리
- Diff 생성 및 변경 사항 추적
- Merge 충돌 감지 및 해결

#### **1.2.5 GitHub 통합 (GitHub Integration)**
- OAuth Device Flow 인증
- 자동 Pull Request 생성
- PR 상태 모니터링
- 브랜치 관리 및 동기화

#### **1.2.6 MCP 프로토콜 지원 (MCP Protocol)**
- Anyon이 **MCP 서버**로 동작
- AI 에이전트가 MCP 클라이언트로 연결하여 원격으로 작업 관리
- 10개 이상의 MCP 도구 제공 (작업 생성, 조회, 실행 등)

### 1.3 시스템 경계 (System Boundaries)

#### **외부 통합 (External Integrations)**
```
┌─────────────────────────────────────────────────────────┐
│                    외부 시스템                             │
├─────────────────────────────────────────────────────────┤
│ • GitHub OAuth & API (인증, PR 관리)                      │
│ • 로컬 파일시스템 (프로젝트 저장소)                          │
│ • AI 에이전트 CLI (Claude Code, Gemini 등)                │
│ • MCP 클라이언트 (AI 에이전트가 MCP로 연결)                 │
│ • 분석 서비스 (PostHog, Sentry)                           │
└─────────────────────────────────────────────────────────┘
```

#### **내부 경계 (Internal Boundaries)**
```
Frontend (React) ←────→ Backend (Rust Axum)
                  HTTP REST API
                  WebSocket (JSON Patch)
                  Server-Sent Events (SSE)

Backend ←────→ Database (SQLite + SQLx)
         SQL Queries
         Compile-time Validation

Backend ←────→ AI Agent CLIs
         Process Spawning
         MCP Protocol (stdio)
```

---

## 2. 핵심 기술 스택

### 2.1 백엔드 기술 스택

#### **프레임워크 & 런타임**
| 기술 | 버전 | 용도 |
|-----|------|-----|
| **Rust** | Edition 2024 | 시스템 프로그래밍 언어 |
| **Axum** | 0.8.4 | 비동기 웹 프레임워크 |
| **Tokio** | 1.0 | 비동기 런타임 |
| **Tower-HTTP** | 0.5 | HTTP 미들웨어 (CORS 등) |

#### **데이터베이스 & ORM**
| 기술 | 버전 | 용도 |
|-----|------|-----|
| **SQLx** | 0.8.6 | 비동기 SQL 툴킷, 컴파일 타임 쿼리 검증 |
| **SQLite** | 3.x | 임베디드 관계형 데이터베이스 |

#### **타입 시스템 & 직렬화**
| 기술 | 버전 | 용도 |
|-----|------|-----|
| **ts-rs** | custom fork | Rust → TypeScript 타입 자동 생성 |
| **serde** | 1.0 | 직렬화/역직렬화 프레임워크 |
| **schemars** | 1.0.4 | JSON Schema 생성 |

#### **Git & VCS**
| 기술 | 버전 | 용도 |
|-----|------|-----|
| **git2** | 0.18 | libgit2 Rust 바인딩 |
| **octocrab** | 0.44 | GitHub API 클라이언트 |

#### **MCP 프로토콜**
| 기술 | 버전 | 용도 |
|-----|------|-----|
| **rmcp** | 0.5.0 | Model Context Protocol 구현 |

#### **기타 핵심 라이브러리**
- **chrono**: 날짜/시간 처리
- **uuid**: 고유 식별자 생성
- **thiserror**: 에러 타입 정의
- **tracing**: 구조화된 로깅
- **command-group**: 프로세스 그룹 관리
- **nix**: POSIX 시스템 콜 (시그널 처리)
- **moka**: 인메모리 캐싱
- **fst**: 빠른 문자열 검색 (FST 인덱싱)
- **json-patch**: RFC 6902 JSON Patch

### 2.2 프론트엔드 기술 스택

#### **프레임워크 & 빌드 도구**
| 기술 | 버전 | 용도 |
|-----|------|-----|
| **React** | 18.2.0 | UI 라이브러리 |
| **TypeScript** | 5.9.2 | 타입 안정성 |
| **Vite** | 5.0.8 | 빌드 도구, HMR |
| **React Router** | 6.8.1 | 클라이언트 사이드 라우팅 |

#### **상태 관리 & 데이터 페칭**
| 기술 | 버전 | 용도 |
|-----|------|-----|
| **TanStack React Query** | 5.85.5 | 서버 상태 관리, 캐싱 |
| **Zustand** | 4.5.4 | 경량 글로벌 상태 관리 |

#### **UI 컴포넌트 & 스타일링**
| 기술 | 버전 | 용도 |
|-----|------|-----|
| **shadcn/ui** | - | Headless 컴포넌트 라이브러리 |
| **Tailwind CSS** | 3.4.0 | 유틸리티 기반 CSS |
| **Radix UI** | 2.x | 접근성 높은 UI 프리미티브 |
| **Framer Motion** | 12.23.24 | 애니메이션 |
| **Lucide React** | 0.539.0 | 아이콘 라이브러리 |

#### **코드 에디팅 & Diff 뷰어**
| 기술 | 버전 | 용도 |
|-----|------|-----|
| **CodeMirror** | 6.x | 코드 에디터 |
| **Lexical** | 0.36.2 | 리치 텍스트 에디터 |
| **@git-diff-view/react** | - | Git Diff 시각화 |

#### **실시간 통신**
| 기술 | 버전 | 용도 |
|-----|------|-----|
| **react-use-websocket** | 4.7.0 | WebSocket 훅 |
| **EventSource API** | 네이티브 | Server-Sent Events |

#### **국제화**
| 기술 | 버전 | 용도 |
|-----|------|-----|
| **i18next** | 25.5.2 | i18n 프레임워크 |
| **react-i18next** | 15.7.3 | React 통합 |

#### **모니터링 & 분석**
| 기술 | 버전 | 용도 |
|-----|------|-----|
| **Sentry** | 9.34.0 | 에러 추적 |
| **PostHog** | 1.276.0 | 제품 분석 |

### 2.3 데이터베이스

**SQLite** (로컬 파일 기반)
- **위치**: `~/.local/share/anyon/dev_assets/db.sqlite` (Unix)
- **특징**:
  - Preupdate Hooks (실시간 변경 감지)
  - 외래 키 제약 조건 활성화
  - ACID 트랜잭션
  - 단일 파일 포맷 (이식성)

**주요 테이블** (12개):
- `projects` - Git 저장소 프로젝트
- `tasks` - 작업 항목
- `task_attempts` - 작업 실행 시도
- `execution_processes` - 개별 프로세스 실행
- `execution_process_logs` - 프로세스 로그
- `executor_sessions` - MCP 세션 상태
- `drafts` - 임시 실행 데이터
- `tags` - 사용자 정의 태그
- `images` - 스크린샷/이미지
- `merges` - PR 정보
- `approvals` - 승인 추적

### 2.4 빌드 도구

| 도구 | 용도 |
|-----|------|
| **Cargo** | Rust 빌드 시스템 |
| **npm/pnpm** | Node 패키지 관리 |
| **sqlx-cli** | 데이터베이스 마이그레이션 |
| **cargo-watch** | 핫 리로드 |

---

## 3. 시스템 아키텍쳐 다이어그램

### 3.1 전체 시스템 구조

```
┌───────────────────────────────────────────────────────────────────┐
│                      ANYON 시스템 아키텍쳐                           │
├───────────────────────────────────────────────────────────────────┤
│                                                                    │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                FRONTEND (React + Vite)                     │  │
│  │  ┌──────────────────────────────────────────────────────┐  │  │
│  │  │ • 작업 관리 UI (Kanban Board, 작업 카드)              │  │  │
│  │  │ • 실행 모니터링 (로그 스트리밍, Diff 뷰어)            │  │  │
│  │  │ • Git 작업 인터페이스 (Merge, Push, Rebase)          │  │  │
│  │  │ • 설정 & 에이전트 구성                                │  │  │
│  │  └──────────────────────────────────────────────────────┘  │  │
│  └────────────────────────┬───────────────────────────────────┘  │
│                           │                                       │
│                  HTTP REST + WebSocket + SSE                      │
│                           │                                       │
│  ┌────────────────────────▼───────────────────────────────────┐  │
│  │        BACKEND SERVER (Axum - Rust) - Port Auto           │  │
│  │  ┌──────────────────────────────────────────────────────┐ │  │
│  │  │ API 라우트 레이어                                      │ │  │
│  │  │ • /api/projects (프로젝트 CRUD)                       │ │  │
│  │  │ • /api/tasks (작업 CRUD)                             │ │  │
│  │  │ • /api/task-attempts (작업 시도 관리)                 │ │  │
│  │  │ • /api/execution-processes (프로세스 추적)            │ │  │
│  │  │ • /api/events (SSE 스트리밍)                          │ │  │
│  │  │ • /api/config (시스템 설정)                           │ │  │
│  │  │ • /auth (GitHub Device Flow)                         │ │  │
│  │  └──────────────────────────────────────────────────────┘ │  │
│  │                                                            │  │
│  │  ┌──────────────────────────────────────────────────────┐ │  │
│  │  │ 핵심 서비스 레이어                                     │ │  │
│  │  │ • ContainerService (프로세스 관리)                    │ │  │
│  │  │ • GitService (Git 작업, 3000+ LOC)                   │ │  │
│  │  │ • GitHubService (PR 관리)                            │ │  │
│  │  │ • WorktreeManager (Git 워크트리 격리)                │ │  │
│  │  │ • EventService (실시간 업데이트 스트리밍)             │ │  │
│  │  │ • DraftsService (임시 실행 관리)                      │ │  │
│  │  │ • FileSearchCache (FST 인덱싱 파일 검색)             │ │  │
│  │  │ • ImageService (이미지 저장소)                        │ │  │
│  │  └──────────────────────────────────────────────────────┘ │  │
│  │                                                            │  │
│  │  ┌──────────────────────────────────────────────────────┐ │  │
│  │  │ AI 에이전트 통합 레이어 (Executor)                    │ │  │
│  │  │ • ClaudeExecutor (Claude Code, 3000+ LOC)           │ │  │
│  │  │ • GeminiExecutor (Google Gemini)                     │ │  │
│  │  │ • CopilotExecutor (GitHub Copilot)                   │ │  │
│  │  │ • CursorExecutor (Cursor IDE)                        │ │  │
│  │  │ • AMP, OpenCode, Qwen, Codex Executors              │ │  │
│  │  └──────────────────────────────────────────────────────┘ │  │
│  │                                                            │  │
│  │  ┌──────────────────────────────────────────────────────┐ │  │
│  │  │ MCP 서버 (Model Context Protocol)                    │ │  │
│  │  │ • list_projects, list_tasks, create_task            │ │  │
│  │  │ • update_task, create_task_attempt                  │ │  │
│  │  │ • AI 에이전트가 원격으로 작업 관리 가능               │ │  │
│  │  └──────────────────────────────────────────────────────┘ │  │
│  └────────────────────────┬───────────────────────────────────┘  │
│                           │                                       │
│              공유 타입 시스템 (ts-rs 자동 생성)                    │
│                           │                                       │
│  ┌────────────────────────▼───────────────────────────────────┐  │
│  │       DATABASE LAYER (SQLite + SQLx 마이그레이션)          │  │
│  │  ┌──────────────────────────────────────────────────────┐ │  │
│  │  │ 핵심 테이블:                                          │ │  │
│  │  │ • projects (프로젝트)      • task_attempts (시도)    │ │  │
│  │  │ • tasks (작업)             • execution_processes     │ │  │
│  │  │ • drafts (임시)            • executor_sessions       │ │  │
│  │  │ • tags (태그)              • images (이미지)         │ │  │
│  │  └──────────────────────────────────────────────────────┘ │  │
│  └────────────────────────────────────────────────────────────┘  │
│                           │                                       │
├───────────────────────────────────────────────────────────────────┤
│                    외부 통합 (External Integrations)               │
│  • GitHub OAuth & API (인증, PR 생성, 브랜치 관리)                 │
│  • AI 에이전트 CLI (Claude Code, Gemini, Copilot 등)              │
│  • 로컬 Git 저장소 (프로젝트 파일)                                  │
│  • 분석 서비스 (PostHog, Sentry)                                   │
└───────────────────────────────────────────────────────────────────┘
```

### 3.2 데이터 흐름 아키텍쳐

#### **3.2.1 작업 실행 플로우**

```
사용자가 작업 실행 시작
        │
        ▼
POST /api/task-attempts (CreateTaskAttemptBody)
        │
        ▼
┌─────────────────────────────────────────────────┐
│ 작업 시도 생성 (Database Transaction)            │
│ • 고유 attempt ID 할당                          │
│ • Git 브랜치 생성 (base_branch → new_branch)   │
│ • Git 워크트리 생성 (격리된 작업 공간)           │
│ • TaskAttempt 레코드 저장                       │
└────────────┬────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────┐
│ 실행 프로세스 생성                               │
│ • LocalContainerService::start_process()       │
│ • Executor CLI 실행 (Claude, Gemini 등)        │
│ • MCP 연결 수립 (해당하는 경우)                  │
│ • stdout/stderr 캡처                           │
└────────────┬────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────┐
│ 실행 모니터링 (백그라운드 작업)                   │
│ • 프로세스 상태 폴링                             │
│ • stdout/stderr 캡처 및 파싱                    │
│ • ExecutionProcess 로그 저장                   │
│ • 코드 변경 시 Diff 생성                        │
│ • SSE를 통한 실시간 업데이트 스트리밍             │
└────────────┬────────────────────────────────────┘
             │
        ┌────┴────┐
        │         │
        ▼         ▼
    성공      실패/타임아웃
        │         │
        │         ├─→ 실패로 표시
        │         ├─→ 워크트리 정리
        │         └─→ 에러 이벤트 발생
        │
        ▼
사용자 승인 대기
    • 사용자 Diff 검토
    • 승인/거부 결정
        │
    ┌───┴───┐
    │       │
    ▼       ▼
 승인    거부
    │       │
    │       └─→ 정리 & 보관
    │
    ▼
GitHub PR 생성
    • Diff 추출
    • GitHub에 브랜치 생성
    • Pull Request 오픈
    • 데이터베이스에 PR 정보 저장
        │
        ▼
병합 (사용자가 GitHub UI에서 병합)
    • WorktreeManager::cleanup_worktree()
    • 작업 상태 업데이트
    • 자식 작업 생성 (있는 경우)
```

#### **3.2.2 실시간 업데이트 플로우**

```
데이터베이스 변경
│
├─→ SQLite Preupdate Hook
│   └─→ EventService::create_hook()
│       └─→ JSON Patch 생성 (RFC 6902)
│
├─→ MsgStore에 푸시
│   └─→ 인메모리 메시지 큐
│
└─→ 프론트엔드 SSE 구독
    └─→ Patch 수신
        └─→ 로컬에 Patch 적용
            └─→ UI 업데이트 (React 리렌더)
```

**예시: 작업 상태 업데이트**
```
Database: UPDATE tasks SET status = 'inprogress' WHERE id = '123'
  ↓
Preupdate Hook: 이전 상태 캡처
  ↓
EventService: Patch 생성:
  [{ op: "replace", path: "/status", value: "inprogress" }]
  ↓
MsgStore: Patch 큐에 추가
  ↓
SSE 클라이언트: Patch 수신
  ↓
프론트엔드: 로컬 상태에 Patch 적용
  ↓
UI: 작업 카드 시각적 업데이트
```

---

## 4. 프로젝트 구조

### 4.1 루트 레벨 구조

```
any-on/
├── crates/                      # Rust 백엔드 워크스페이스
│   ├── server/                  # HTTP 서버 & 라우트
│   ├── db/                      # 데이터베이스 모델 & 액세스
│   ├── services/                # 비즈니스 로직 서비스
│   ├── executors/               # AI 에이전트 통합
│   ├── deployment/              # Deployment 트레이트 정의
│   ├── local-deployment/        # 로컬 구현
│   ├── utils/                   # 공유 유틸리티
│   └── Cargo.toml              # 워크스페이스 정의
│
├── frontend/                    # React/TypeScript 애플리케이션
│   ├── src/
│   │   ├── components/         # React 컴포넌트
│   │   ├── hooks/              # 커스텀 React 훅 (40+개)
│   │   ├── pages/              # 라우트 페이지
│   │   ├── lib/                # 유틸리티 & API 클라이언트
│   │   ├── contexts/           # React 컨텍스트
│   │   ├── stores/             # Zustand 스토어
│   │   └── App.tsx             # 루트 컴포넌트
│   ├── public/                 # 정적 자산
│   └── package.json
│
├── shared/                      # 공유 타입
│   ├── types.ts                # 자동 생성 타입 (ts-rs)
│   └── schemas/                # 에이전트용 JSON Schema
│
├── anyon-web-companion/        # 웹 익스텐션 컴패니언
│   └── packages/*              # 여러 패키지
│
├── scripts/                     # 빌드 & 개발 스크립트
├── assets/                      # 정적 자산
├── docs/                        # 문서
├── dev_assets_seed/            # 개발용 시드 데이터베이스
│
├── Cargo.toml                  # Rust 워크스페이스 루트
├── Cargo.lock                  # Rust 의존성 락
├── package.json                # NPM 루트 패키지
├── pnpm-workspace.yaml         # pnpm 모노레포 설정
│
├── CLAUDE.md                   # AI용 개발 규칙
├── AGENTS.md                   # 에이전트 문서
├── README.md                   # 프로젝트 README
└── .mcp.json                  # MCP 서버 설정
```

### 4.2 백엔드 Crate 구조

#### **4.2.1 `crates/server` - HTTP 서버**

**목적:** HTTP API 엔드포인트, 라우팅, 미들웨어, MCP 서버

**주요 파일:**
```
src/
├── main.rs                     # 진입점, 서버 초기화
├── lib.rs                      # 라이브러리 내보내기
├── error.rs                    # 에러 처리 미들웨어
├── routes/
│   ├── mod.rs                 # 라우트 조립
│   ├── auth.rs                # GitHub OAuth 엔드포인트
│   ├── projects.rs            # 프로젝트 CRUD
│   ├── tasks.rs               # 작업 CRUD
│   ├── task_attempts.rs       # 작업 시도 엔드포인트 (4500+ 라인)
│   ├── execution_processes.rs # 프로세스 실행 추적
│   ├── drafts.rs              # 임시 작업 실행
│   ├── events.rs              # Server-Sent Events
│   ├── config.rs              # 시스템 설정
│   ├── tags.rs                # 태그 관리
│   ├── images.rs              # 이미지 저장
│   ├── approvals.rs           # 승인 워크플로우
│   ├── containers.rs          # 컨테이너 관리
│   └── filesystem.rs          # 파일 작업
├── middleware/                # 인증, 로깅
├── mcp/                       # MCP 서버 구현
│   └── task_server.rs        # 작업 관리용 MCP 도구
└── bin/                       # 바이너리 타겟
    └── generate_types.rs     # TypeScript 타입 생성
```

#### **4.2.2 `crates/db` - 데이터베이스 레이어**

**목적:** 데이터베이스 모델, 마이그레이션, 쿼리 빌더

**주요 파일:**
```
src/
├── lib.rs                     # DBService 정의
└── models/
    ├── project.rs            # Project 구조체 & 쿼리
    ├── task.rs               # Task 구조체 & 쿼리
    ├── task_attempt.rs       # TaskAttempt 구조체 & 쿼리
    ├── execution_process.rs  # ExecutionProcess & 로그
    ├── executor_session.rs   # MCP executor 세션
    ├── draft.rs              # Draft 실행 데이터
    ├── tag.rs                # 사용자 태그
    ├── image.rs              # 이미지 메타데이터
    └── merge.rs              # PR/병합 정보

migrations/                    # 40+ 타임스탬프 SQL 마이그레이션
├── 20250617183714_init.sql
├── 20250620212427_execution_processes.sql
└── ...                       # 최신: 20250716170000
```

#### **4.2.3 `crates/services` - 비즈니스 로직**

**목적:** 핵심 도메인 로직, 통합 구현

**주요 서비스 (24개 모듈):**
```
src/services/
├── auth.rs                    # GitHub OAuth device flow
├── git.rs                     # Git 작업 (3000+ 라인)
├── git_cli.rs                 # Git CLI 래퍼
├── github_service.rs          # GitHub API 통합
├── worktree_manager.rs        # Git 워크트리 격리
├── container.rs               # 프로세스 실행 컨테이너
├── drafts.rs                  # 임시 실행 관리
├── events.rs                  # 실시간 스트리밍 업데이트
│   ├── patches.rs            # Diff용 JSON patch
│   ├── streams.rs            # 이벤트 스트리밍 로직
│   └── types.rs              # 이벤트 타입 정의
├── file_search_cache.rs       # FST 인덱싱 파일 검색
├── file_ranker.rs             # 스마트 파일 랭킹
├── filesystem.rs              # 파일 작업
├── filesystem_watcher.rs      # 파일 변경 감시
├── diff_stream.rs             # Diff 변경 스트리밍
├── image.rs                   # 이미지/스크린샷 저장
├── config.rs                  # 사용자 설정
├── analytics.rs               # 분석 추적
├── approvals.rs               # 승인 워크플로우
├── pr_monitor.rs              # PR 상태 모니터링
└── notification.rs            # 시스템 알림
```

#### **4.2.4 `crates/executors` - AI 에이전트 통합**

**목적:** 다양한 AI 코딩 에이전트와의 통합

**Executor 구현 (9개 에이전트):**
```
src/executors/
├── claude.rs                  # Claude Code (3000+ 라인)
├── gemini.rs                  # Google Gemini
├── copilot.rs                 # GitHub Copilot
├── cursor.rs                  # Cursor IDE
├── opencode.rs                # OpenCode
├── qwen.rs                    # Alibaba Qwen
├── amp.rs                     # AMP executor
├── codex.rs                   # OpenAI Codex
└── acp/                       # 추가 프로토콜 지원

├── command.rs                 # 커맨드 빌더/executor
├── profile.rs                 # Executor 설정 프로파일
├── mcp_config.rs              # MCP 설정 관리
├── actions.rs                 # Executor 액션 enum
├── approvals.rs               # Executor 승인 플로우
├── logs/                      # 로그 파싱 & 스트리밍
└── stdout_dup.rs              # Stdout 캡처
```

### 4.3 프론트엔드 구조

```
frontend/src/
├── App.tsx                    # 루트 컴포넌트
├── main.tsx                   # Vite 진입점
├── components/
│   ├── layout/               # Navbar, sidebar, panels
│   ├── tasks/                # 작업 카드, 폼, 리스트
│   ├── dialogs/              # 모달 다이얼로그 (20+ 종류)
│   ├── panels/               # Diff, 로그, 대화 패널
│   ├── projects/             # 프로젝트 카드, 리스트
│   ├── settings/             # 설정 페이지
│   ├── ui/                   # 기본 UI 컴포넌트 (shadcn)
│   └── ...
│
├── hooks/                    # 커스텀 React 훅 (40+ 파일)
│   ├── useAttemptExecution.ts
│   ├── useConversationHistory.ts
│   ├── useDiffStream.ts
│   ├── useEventSourceManager.ts
│   ├── useLogStream.ts
│   ├── useProjectTasks.ts
│   └── ...
│
├── pages/                    # 라우트 페이지
├── stores/                   # Zustand 스토어
├── lib/                      # 유틸리티
│   ├── api.ts               # API 클라이언트
│   ├── websocket.ts         # WebSocket 유틸리티
│   └── ...
│
├── contexts/                # React 컨텍스트 (12개 파일)
├── types/                   # TypeScript 타입 정의
├── styles/                  # Tailwind 설정
└── i18n/                    # 국제화 (다국어)
```

---

## 5. 핵심 아키텍쳐 패턴

### 5.1 통신 패턴

#### **5.1.1 REST API (HTTP/JSON)**

**기본 경로:** `/api/*`

**주요 엔드포인트:**
```
GET    /api/health                    # 헬스 체크
GET    /api/projects                  # 프로젝트 목록
POST   /api/projects                  # 프로젝트 생성
GET    /api/projects/{id}             # 프로젝트 조회
PUT    /api/projects/{id}             # 프로젝트 업데이트

GET    /api/tasks                     # 작업 목록
POST   /api/tasks                     # 작업 생성
GET    /api/tasks/{id}                # 작업 조회
PUT    /api/tasks/{id}                # 작업 업데이트

POST   /api/task-attempts             # 실행 시작
GET    /api/task-attempts/{id}        # 시도 상태 조회
POST   /api/task-attempts/{id}/merge  # 변경사항 병합

GET    /api/execution-processes       # 프로세스 목록
GET    /api/execution-processes/{id}  # 프로세스 조회

GET    /api/config                    # 시스템 설정 조회
PUT    /api/config                    # 설정 업데이트

GET    /auth/device-start             # GitHub 인증 시작
GET    /auth/device-poll              # 인증 상태 폴링
```

**응답 포맷:**
```typescript
interface ApiResponse<T> {
  success: boolean;
  data: T | null;
  error_data?: T | null;
  message: string | null;
}
```

#### **5.1.2 Server-Sent Events (SSE)**

**목적:** WebSocket 복잡성 없이 실시간 업데이트 스트리밍

**이벤트 스트림:**
```
GET /api/events/processes/{processId}/logs
- 스트림: ExecutionProcess 로그 실시간
- 형식: LogMsg (ANSI 텍스트)
- 용도: 라이브 로그 보기

GET /api/events/task-attempts/{attemptId}/diff
- 스트림: JSON patch로 Diff 변경사항
- 형식: RFC 6902 JSON Patch
- 용도: 실시간 파일 diff 보기

GET /api/events/{entityType}/{entityId}
- 스트림: 엔티티 업데이트
- 형식: JSON Patch
- 용도: 실시간 UI 업데이트
```

**구현:**
- `MsgStore` - 스트림당 인메모리 메시지 큐
- SQLite preupdate 훅이 patch 생성 트리거
- 클라이언트가 엔티티 변경 사항 구독
- 연결 해제 시 자동 정리

#### **5.1.3 WebSocket (Reserved)**

**상태:** 현재 사용하지 않음
**이유:** 현재 요구사항에 SSE로 충분
**기능 플래그:** `axum`에 `ws` 기능 활성화됨

#### **5.1.4 MCP (Model Context Protocol)**

**역할:** Anyon이 MCP 서버로 동작

**연결 타입:** Stdio 트랜스포트 (에이전트 프로세스가 stdin/stdout으로 통신)

**사용 가능한 도구:**
```
list_projects
  - 반환: 모든 프로젝트 목록

list_tasks
  - 매개변수: project_id, [status], [limit]
  - 반환: 실행 상태가 있는 작업 목록

get_task
  - 매개변수: task_id
  - 반환: 관계가 있는 전체 작업 상세 정보

create_task
  - 매개변수: project_id, title, [description]
  - 반환: 생성된 작업 ID

update_task
  - 매개변수: task_id, [title], [description], [status]
  - 반환: 업데이트된 작업

create_task_attempt
  - 매개변수: task_id, executor, base_branch
  - 반환: Attempt ID, 즉시 실행

get_attempt_status
  - 매개변수: attempt_id
  - 반환: 실행 상태, 로그, diff
```

**구현 위치:** `crates/server/src/mcp/task_server.rs`

### 5.2 타입 공유 메커니즘 (ts-rs)

#### **5.2.1 워크플로우**

```
RUST 구조체 (#[derive(TS)] 포함)
│
└─→ cargo run --bin generate_types
    ├─→ Rust 타입 정의 파싱
    ├─→ TypeScript 동등물 생성
    └─→ shared/types.ts에 작성
        │
        ├─→ Task가 TaskResponse가 됨
        ├─→ Enum 변형이 판별된 유니온이 됨
        ├─→ Option<T>가 T | null이 됨
        └─→ DateTime<Utc>가 Date가 됨
        │
        ▼
    프론트엔드 사용
    │
    ├─→ shared/types에서 임포트
    ├─→ API 사용 시 완전한 타입 안정성
    ├─→ 컴파일 시간에 breaking 변경 감지
    └─→ 타입 불일치 없음
```

#### **5.2.2 핵심 규칙**

**반드시 해야 할 것:**
- `#[derive(TS)]`가 있는 Rust 구조체 수정 후:
  - 즉시 `npm run generate-types` 실행
  - Rust 변경사항과 생성된 타입 모두 커밋

**절대 하지 말아야 할 것:**
- `shared/types.ts` 수동 편집 금지
- 타입 생성 건너뛰기 금지
- 타입 없는 API 응답 사용 금지

#### **5.2.3 생성된 타입 예시**

**Rust:**
```rust
#[derive(Debug, Clone, TS)]
pub struct Task {
    pub id: Uuid,
    pub title: String,
    pub status: TaskStatus,
    pub created_at: DateTime<Utc>,
}

#[derive(TS)]
#[ts(rename_all = "lowercase")]
pub enum TaskStatus {
    Todo,
    InProgress,
    Done,
}
```

**생성된 TypeScript:**
```typescript
export type Task = {
  id: string;
  title: string;
  status: TaskStatus;
  created_at: Date;
};

export type TaskStatus = "todo" | "inprogress" | "done";
```

---

## 6. 주요 서브시스템

### 6.1 인증 & 권한

#### **6.1.1 GitHub OAuth Device Flow**

**위치:** `crates/services/src/services/auth.rs`

**플로우:**
```
1. 사용자가 "GitHub로 연결" 클릭
   └─→ GET /auth/device-start
       └─→ 반환: user_code, verification_uri, expires_in

2. 프론트엔드가 사용자를 GitHub verification_uri로 안내
   └─→ 사용자가 user_code 입력
   └─→ GitHub이 권한 부여 프롬프트

3. 프론트엔드가 완료 폴링
   └─→ GET /auth/device-poll (5초마다)
   └─→ 사용자가 승인할 때까지 PENDING 반환

4. 사용자 승인 → 폴이 access_token 반환
   └─→ 프론트엔드가 토큰 안전하게 저장
   └─→ 모든 GitHub API 호출에 토큰 사용

5. 다음 세션 시작 시 토큰 갱신
   └─→ Device flow 재시도 가능
```

**요청된 스코프:**
- `user:email` - 사용자 이메일 읽기
- `repo` - 전체 저장소 액세스 (clone, push, PR 생성)

**토큰 저장:**
- `.config/anyon/config.toml`에 저장 (가능하면 암호화)
- GitHub 서비스에 API 호출용으로 전달
- Git CLI가 push/pull 작업에 사용

### 6.2 작업 관리 시스템

#### **6.2.1 작업 엔티티**

**데이터베이스 모델:**
```sql
CREATE TABLE tasks (
  id UUID PRIMARY KEY,
  project_id UUID NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  status TEXT NOT NULL, -- todo|inprogress|inreview|done|cancelled
  parent_task_attempt UUID,  -- FK to TaskAttempt (하위 작업 연결)
  created_at TIMESTAMP NOT NULL,
  updated_at TIMESTAMP NOT NULL,
  FOREIGN KEY(project_id) REFERENCES projects(id),
  FOREIGN KEY(parent_task_attempt) REFERENCES task_attempts(id)
);
```

**관계:**
```
Task (1) ──→ (N) TaskAttempt
     ↑                ↓
     └─── 부모         └─→ 자식 작업
```

**작업 라이프사이클:**
```
todo
  ↓
inprogress (실행 시작 시)
  ↓
inreview (실행 후, 승인 대기 중)
  ↓
done (PR 병합 후)

또는: cancelled (어느 시점에서든)
```

#### **6.2.2 작업 시도 엔티티**

**목적:** 작업의 한 번의 실행 시도를 나타냄

**주요 필드:**
```rust
pub struct TaskAttempt {
    pub id: Uuid,
    pub task_id: Uuid,
    pub branch: String,           // 예: "task-123-feature-xyz"
    pub target_branch: String,    // 예: "main"
    pub executor: String,         // 예: "CLAUDE_CODE"
    pub container_ref: Option<String>,  // 워크트리 경로
    pub worktree_deleted: bool,
    pub setup_completed_at: Option<DateTime<Utc>>,
}
```

**작업당 여러 시도:**
- 사용자가 실패한 작업 재시도 가능
- 각 재시도가 새로운 TaskAttempt
- 각 시도가 고유한 브랜치 & 워크트리 얻음

### 6.3 AI Executor 통합

#### **6.3.1 Executor 아키텍쳐**

**위치:** `crates/executors/src/executors/`

**지원하는 에이전트:**
1. **Claude Code** - Anthropic (3000+ LOC)
2. **Gemini** - Google
3. **Copilot** - GitHub
4. **Cursor** - Cursor IDE
5. **AMP** - 범용 executor
6. **OpenCode** - OpenCode executor
7. **Qwen Code** - Alibaba Qwen
8. **Codex** - OpenAI Codex (레거시)

#### **6.3.2 Executor 추상화**

**트레이트 기반 디자인:**
```rust
#[async_trait]
pub trait Executor {
    async fn execute_initial_request(
        &self,
        request: CodingAgentInitialRequest,
    ) -> Result<ExecutorResult>;

    async fn execute_follow_up(
        &self,
        request: CodingAgentFollowUpRequest,
    ) -> Result<ExecutorResult>;
}
```

**각 Executor가 처리:**
- 커맨드 빌드 (매개변수, MCP 설정)
- 프로세스 생성
- Stdout/stderr 파싱
- 상태 추적

### 6.4 Git 워크트리 관리

#### **6.4.1 WorktreeManager**

**위치:** `crates/services/src/services/worktree_manager.rs`

**목적:** 각 작업 실행을 자체 Git 워크트리에 격리

**워크플로우:**
```
워크트리 생성
    ├─→ base_branch = "main"
    ├─→ new_branch = "task-123-feature"
    ├─→ worktree_path = "/tmp/anyon-worktrees/task-123"
    │
    ├─→ git worktree add
    │    --track
    │    -b task-123-feature
    │    /tmp/anyon-worktrees/task-123
    │    origin/main
    │
    └─→ TaskAttempt.container_ref = worktree_path 저장

워크트리 정리 (병합/취소 시)
    ├─→ 워크트리 디렉토리 제거
    ├─→ 브랜치 삭제
    ├─→ TaskAttempt.worktree_deleted = true 업데이트
    └─→ 고아 감지 & 정리 (백그라운드 작업)
```

**장점:**
- 격리된 실행 환경
- 파일 충돌 없음
- 깨끗한 작업 공간 상태
- 쉬운 롤백 (디렉토리 삭제)

**경쟁 조건 방지:**
```rust
lazy_static! {
    static ref WORKTREE_CREATION_LOCKS:
        Arc<Mutex<HashMap<String, Arc<tokio::sync::Mutex<()>>>>> = ...
}
// 동일한 저장소에서 동시 작업 방지
```

### 6.5 MCP 서버

#### **6.5.1 개요**

**MCP란?**
- AI 에이전트가 도구와 통신하기 위한 프로토콜
- AI 에이전트가 서비스를 요청하는 방법 표준화
- Anthropic이 정의

**Anyon의 역할:**
- MCP 서버로 동작
- AI 에이전트(Claude Code, Gemini 등)가 클라이언트
- 에이전트가 stdio를 통해 도구 요청 전송

#### **6.5.2 사용 가능한 MCP 도구**

**위치:** `crates/server/src/mcp/task_server.rs`

**도구 세트:**
```
list_projects()
  반환: 메타데이터가 있는 모든 프로젝트

list_tasks(project_id, status?, limit?)
  반환: 프로젝트의 작업, 선택적으로 필터링됨

get_task(task_id)
  반환: 전체 작업 상세 정보 + 관계

create_task(project_id, title, description?)
  반환: 새로 생성된 작업

update_task(task_id, updates...)
  반환: 업데이트된 작업

create_task_attempt(task_id, executor, base_branch)
  반환: 즉시 실행, attempt_id 반환

get_attempt_status(attempt_id)
  반환: 상태, 실행 로그, diff

update_task_status(task_id, status)
  반환: 업데이트된 작업
```

### 6.6 이벤트 스트리밍 시스템

#### **6.6.1 아키텍쳐**

**구성요소:**
- `EventService` - 오케스트레이터
- `MsgStore` - 인메모리 큐
- `SQLite Preupdate Hooks` - 변경 감지
- `SSE Endpoint` - 클라이언트 구독

#### **6.6.2 Preupdate Hook 메커니즘**

**SQLite 기능:**
```
Pre-Update Hook
    │
    ├─→ INSERT/UPDATE/DELETE 전에 호출됨
    ├─→ OLD 및 NEW 값에 액세스 가능
    └─→ 변경사항 계산 가능

Anyon 사용:
    ├─→ JSON Patch 생성 (RFC 6902)
    ├─→ MsgStore에 푸시
    └─→ 연결된 클라이언트로 스트리밍
```

---

## 7. 데이터 아키텍쳐

### 7.1 데이터베이스 스키마 개요

**핵심 엔티티:**

```sql
-- 프로젝트 (사용자의 git 저장소)
projects
  ├─ id (UUID, primary key)
  ├─ name
  ├─ git_repo_path
  ├─ setup_script
  ├─ dev_script
  ├─ cleanup_script
  ├─ copy_files
  └─ timestamps

-- 작업 (작업 항목)
tasks
  ├─ id (UUID)
  ├─ project_id (FK)
  ├─ title
  ├─ description
  ├─ status (enum)
  ├─ parent_task_attempt (FK) -- 하위 작업용
  └─ timestamps

-- 작업 시도 (실행 시도)
task_attempts
  ├─ id (UUID)
  ├─ task_id (FK)
  ├─ branch
  ├─ target_branch
  ├─ executor
  ├─ container_ref (워크트리 경로)
  ├─ worktree_deleted
  ├─ setup_completed_at
  └─ timestamps

-- 실행 프로세스 (개별 프로세스 실행)
execution_processes
  ├─ id (UUID)
  ├─ task_attempt_id (FK)
  ├─ status (running|success|failed|killed)
  ├─ run_reason (CodeAgent|SetupScript|CleanupScript|DevServer)
  ├─ executor_type
  ├─ exit_code
  └─ timestamps
```

### 7.2 마이그레이션 전략

**파일 패턴:** `YYYYMMDDHHMMSS_description.sql`

**현재 마이그레이션:** 40+ 타임스탬프 마이그레이션

**주요 마이그레이션:**
```
20250617183714_init.sql                    # 초기 스키마
20250620212427_execution_processes.sql     # 프로세스 추적
20250623120000_executor_sessions.sql       # MCP 세션 상태
20250715154859_add_task_templates.sql      # 작업 템플릿
20250716161432_update_executor_names.sql   # 스키마 개선
```

**규칙:**
1. 기존 마이그레이션 절대 수정 금지
2. 각 스키마 변경마다 새 마이그레이션 생성
3. 생성 후 `sqlx migrate run` 실행
4. 타임스탬프가 올바른 순서 보장

---

## 8. 통합 포인트

### 8.1 GitHub 통합

**기능:**
- OAuth device flow 인증
- 저장소 정보 검색
- Pull request 생성
- 브랜치 관리
- 커밋 히스토리
- 사용자 정보

**API 클라이언트:** `octocrab` (비동기 GitHub API 래퍼)

### 8.2 AI 모델 통합

**각 Executor 구현:**
1. 커맨드 빌드
2. 프로세스 생성
3. Stdout/stderr 캡처
4. 상태 추적
5. MCP 설정

### 8.3 외부 서비스

**분석 (PostHog):**
- 세션 시작, 작업 생성, 실행 시작, PR 생성 등 이벤트 추적
- 기본적으로 opt-out
- 개인정보 보호 우선 설계

**에러 추적 (Sentry):**
- 처리되지 않은 예외
- 추적 스팬
- 성능 메트릭

---

## 9. 개발 워크플로우

### 9.1 타입 동기화 체인

**필수 워크플로우:**

```
1. Rust 구조체 수정
   ├─→ #[derive(TS)]가 있는 필드 추가/제거/변경
   └─→ 예: Task 구조체에 new_field: String 추가

2. 타입 재생성
   └─→ npm run generate-types
       ├─→ generate_types 바이너리 컴파일
       ├─→ Rust 코드 파싱
       └─→ shared/types.ts 덮어쓰기

3. 프론트엔드 업데이트
   ├─→ 업데이트된 타입 임포트
   ├─→ TypeScript 컴파일러가 사용 검증
   ├─→ 타입 불일치 수정
   └─→ 타입이 API 호환성 보장

4. 둘 다 커밋
   ├─→ git add crates/.../lib.rs
   ├─→ git add shared/types.ts
   └─→ git commit "feat: add new_field to Task"
```

### 9.2 데이터베이스 마이그레이션 워크플로우

**올바른 마이그레이션 단계:**

```
1. 스키마 변경 설계
   ├─→ SQL 변경 계획
   ├─→ 팀과 논의
   └─→ 근거 문서화

2. 마이그레이션 생성
   └─→ sqlx migrate add description_here
       ├─→ YYYYMMDDHHMMSS_description.sql 생성
       └─→ SQL 파일 편집

3. 마이그레이션 실행
   └─→ sqlx migrate run
       ├─→ 개발 데이터베이스에 적용
       └─→ 잘못된 SQL이면 실패

4. Rust 모델 업데이트
   ├─→ crates/db/src/models/*.rs
   ├─→ 필드 추가/제거
   ├─→ 파생된 메서드 업데이트
   └─→ cargo check

5. 프론트엔드 타입 업데이트
   └─→ npm run generate-types
       ├─→ 타입이 새 스키마 자동 반영
       └─→ 프론트엔드가 새 필드 얻음

6. 모든 것 검증
   └─→ npm run check
       ├─→ 프론트엔드 타입 체크
       ├─→ 백엔드 컴파일
       └─→ 데이터베이스 액세스 작동

7. 변경사항 커밋
   └─→ 마이그레이션 + Rust + 생성된 타입 포함
```

---

## 10. 필수 개발 규칙

### 규칙 1: 타입 동기화 체인

**규칙:** Rust 구조체 변경 → `npm run generate-types` → 프론트엔드 변경

**반드시 해야 할 것:**
- `#[derive(TS)]`가 있는 Rust 구조체 수정 후 즉시 `npm run generate-types` 실행
- `shared/types.ts` 절대 수동 편집 금지 - 덮어써질 것임

**절대 하지 말 것:**
- Rust 변경 후 타입 생성 건너뛰기
- `shared/types.ts` 수동 수정

### 규칙 2: 데이터베이스 마이그레이션 규칙

**규칙:** 마이그레이션은 `YYYYMMDDHHMMSS_description.sql` 형식 사용, 생성 후 절대 수정 금지

**반드시 해야 할 것:**
- 올바른 타임스탬프 형식으로 새 마이그레이션 생성: `sqlx migrate add description_here`
- 스키마 변경 후: 1) 마이그레이션 생성 → 2) `sqlx migrate run` 실행 → 3) `crates/db/src/models/`의 모델 업데이트

**절대 하지 말 것:**
- 기존 마이그레이션 파일 수정 또는 삭제
- 잘못된 타임스탬프 형식 사용
- 마이그레이션 생성 후 실행 건너뛰기

### 규칙 3: 개발 워크플로우

**규칙:** API 스펙 먼저 계획, 그 다음 어떤 순서로든 구현. Rust 타입 변경 시 즉시 동기화.

**반드시 해야 할 것:**
- **코딩 전**: API 스펙과 데이터 구조 합의
- **코딩 중**: 필요하면 프론트엔드가 모의 데이터로 먼저 시작 가능
- **Rust 구조체 변경 시**: 즉시 `npm run generate-types` 실행하고 프론트엔드 동기화
- **완료 전**: `npm run check` 실행

### 규칙 4: 자동 생성 코드

**규칙:** 자동 생성된 파일 절대 수동 편집 금지

**자동 생성 파일:**
- `shared/types.ts` - Rust 구조체에서 ts-rs로 생성
- 상단에 "수동 편집 금지" 주석이 있는 모든 파일

**반드시 해야 할 것:**
- 생성된 파일(TypeScript) 대신 소스(Rust) 편집
- 소스 변경 후 재생성

---

## 11. 아키텍쳐 의사결정 근거

### 11.1 왜 SQLite?

**장점:**
- 설정 불필요
- 서버 필요 없음
- 파일 기반 (이식 가능, git으로 버전 관리 가능)
- 완전한 ACID 트랜잭션
- 실시간 업데이트용 Preupdate 훅

**트레이드오프:**
- 단일 작성자 제한 (로컬 사용에는 허용 가능)
- 다중 서버 배포에는 이상적이지 않음
- 필요하면 나중에 PostgreSQL로 업그레이드 가능

### 11.2 왜 Axum?

**장점:**
- Tokio/Tower(업계 표준) 기반
- HTTP에 대한 최소한의 추상화
- 타입 안전 라우팅
- 우수한 에러 처리
- 훌륭한 미들웨어 생태계

### 11.3 왜 ts-rs?

**장점:**
- 단일 진실의 원천(Rust)
- 100% 타입 안정성 보장
- 스키마 드리프트 없음
- 오프라인 작동
- 생성된 타입은 단순한 TypeScript

**vs. OpenAPI:**
- OpenAPI는 수동 유지보수 필요
- ts-rs는 자동 생성

**vs. GraphQL:**
- 현재 사용 사례에는 REST가 더 단순
- GraphQL은 복잡성 추가

### 11.4 왜 Git 워크트리?

**장점:**
- 격리된 파일시스템 상태
- 동시 작업 간 충돌 없음
- 개발 서버 병렬 실행 가능
- 쉬운 정리(디렉토리 삭제)
- CI/CD 친화적

### 11.5 왜 MCP 서버?

**장점:**
- AI 통합을 위한 표준 프로토콜
- Claude, Gemini 등과 작동
- 미래 지향적
- 원격 작업 관리 허용
- 명확한 관심사 분리

---

## 12. 성능 고려사항

### 12.1 캐싱

**파일 검색 캐시:**
- FST (Fast String Table) 인덱싱
- Moka 인메모리 캐시
- 파일 와처 무효화
- 프로젝트 변경 시 재구축

**시간 복잡도:**
- 인덱스 구축: O(n) (n = 파일 수)
- 검색: O(log m) (m = 인덱스 크기)

### 12.2 스트리밍

**대용량 데이터 처리:**
- 연속 업데이트용 SSE
- 전체 상태 대신 JSON Patch
- 청크 응답 인코딩
- 200MB 누적 diff 제한

### 12.3 프로세스 관리

**동시 실행:**
- 프로세스 격리용 command-group
- 시도당 워크트리
- 시도 간 공유 상태 없음

### 12.4 데이터베이스 최적화

**인덱스:**
- 외래 키 인덱스
- 상태 enum 인덱스
- 정렬용 타임스탬프 인덱스

**연결 풀:**
- SQLitePoolOptions
- After_connect 훅
- Preupdate 훅 등록

---

## 13. 보안 고려사항

### 13.1 인증
- **GitHub OAuth Device Flow** - GitHub가 검증
- **토큰 저장** - 사용자 설정 디렉토리에 저장
- **토큰 스코프** - 최소한 (user:email, repo)

### 13.2 권한
- **현재 RBAC 없음** - 인증된 사용자가 모든 프로젝트 액세스 가능
- **향후** - 프로젝트별 권한

### 13.3 서브프로세스 실행
- **프로세스 그룹** - command-group으로 적절한 정리
- **시그널 처리** - POSIX 시그널용 nix 크레이트 사용
- **작업 디렉토리** - 격리된 워크트리가 교차 오염 방지
- **환경** - MCP 설정 안전하게 전달

### 13.4 파일 작업
- **.gitignore 존중** - ignore 크레이트 통해
- **경로 정규화** - 경로 문제용 dunce 사용
- **임시 파일** - tempfile 크레이트 사용

---

## 14. 부록: 주요 통계

- **Rust Crates**: 7개 주요 크레이트 + utils
- **데이터베이스 마이그레이션**: 40+
- **API 엔드포인트**: 25+
- **AI Executors**: 9개 지원 에이전트
- **프론트엔드 컴포넌트**: 100+
- **커스텀 React 훅**: 40+
- **데이터베이스 테이블**: 12+
- **코드 라인 (Executors)**: 5,767
- **코드 라인 (Services)**: 18,000+
- **버전**: 0.0.116 (활발한 개발 중)

---

## 결론

Anyon은 다중 AI 코딩 에이전트 실행 관리 문제를 해결하는 정교한 작업 오케스트레이션 플랫폼입니다. 그 아키텍쳐는 다음을 보여줍니다:

1. **타입 안정성** - 자동 생성 TypeScript 타입이 있는 Rust 백엔드
2. **실시간 업데이트** - SQLite preupdate 훅이 있는 Server-Sent Events
3. **격리** - 동시 안전 실행을 위한 Git 워크트리
4. **통합** - MCP 프로토콜을 통한 9개 AI 에이전트 지원
5. **개발 경험** - 핫 리로드, 타입 동기화, 명확한 워크플로우

중요한 개발 규칙(타입 동기화, 마이그레이션, 자동 생성 파일)은 시스템 무결성을 유지하기 위해 반드시 따라야 합니다. 모노레포 구조는 프론트엔드, 백엔드, 공유 코드 간 명확한 경계로 빠른 반복을 가능하게 합니다.
