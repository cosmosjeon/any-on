# 마이그레이션 이력

## 목차
1. [개요](#개요)
2. [마이그레이션 원칙](#마이그레이션-원칙)
3. [전체 타임라인](#전체-타임라인)
4. [주요 변경사항 상세](#주요-변경사항-상세)
5. [Breaking Changes](#breaking-changes)

---

## 개요

**마이그레이션 도구**: SQLx migrations
**총 마이그레이션 수**: 46개
**기간**: 2025-06-17 ~ 2025-10-20
**명명 규칙**: `YYYYMMDDHHMMSS_description.sql`

### 마이그레이션 실행 방법

```bash
# 마이그레이션 적용
sqlx migrate run

# 새 마이그레이션 생성
sqlx migrate add description_here

# 마이그레이션 상태 확인
sqlx migrate info
```

---

## 마이그레이션 원칙

### 1. 불변성 (Immutability)
- **절대 수정 금지**: 이미 적용된 마이그레이션은 절대 수정하지 않음
- **롤백 불가**: SQLx는 롤백을 지원하지 않음 (forward-only)
- **수정 필요 시**: 새로운 마이그레이션 추가

### 2. 타임스탬프 기반 순서
- `YYYYMMDDHHMMSS` 형식으로 실행 순서 보장
- 동시 개발 시 충돌 주의 (같은 시각에 생성 가능)

### 3. 트랜잭션 안정성
- `PRAGMA foreign_keys = ON` 명시
- ALTER TABLE은 SQLite 제약으로 인해 제한적

### 4. 데이터 마이그레이션
- 스키마 변경 시 기존 데이터 보존
- NULL 허용 컬럼 추가 또는 DEFAULT 값 설정

---

## 전체 타임라인

### Phase 1: 초기 스키마 (2025-06-17 ~ 2025-06-23)

| 날짜 | 파일명 | 변경사항 |
|------|--------|----------|
| 2025-06-17 | `20250617183714_init.sql` | 초기 스키마: projects, tasks, task_attempts, task_attempt_activities |
| 2025-06-20 | `20250620212427_execution_processes.sql` | execution_processes 테이블 추가 |
| 2025-06-20 | `20250620214100_remove_stdout_stderr_from_task_attempts.sql` | task_attempts에서 stdout/stderr 제거 |
| 2025-06-21 | `20250621120000_relate_activities_to_execution_processes.sql` | activities와 execution_processes 연결 |
| 2025-06-23 | `20250623120000_executor_sessions.sql` | executor_sessions 테이블 추가 |
| 2025-06-23 | `20250623130000_add_executor_type_to_execution_processes.sql` | executor_type 컬럼 추가 |

**핵심 변경**:
- 초기 구조는 `task_attempt_activities`로 상태 관리
- `execution_processes`로 프로세스 실행 추적 분리
- AI 세션 추적을 위한 `executor_sessions` 추가

---

### Phase 2: Git 통합 (2025-06-25 ~ 2025-07-10)

| 날짜 | 파일명 | 변경사항 |
|------|--------|----------|
| 2025-06-25 | `20250625000000_add_dev_script_to_projects.sql` | projects에 dev_script 추가 |
| 2025-07-01 | `20250701000000_add_branch_to_task_attempts.sql` | task_attempts에 branch 추가 |
| 2025-07-01 | `20250701000001_add_pr_tracking_to_task_attempts.sql` | PR 추적 컬럼 추가 (pr_url, pr_number, pr_status, pr_merged_at) |
| 2025-07-01 | `20250701120000_add_assistant_message_to_executor_sessions.sql` | executor_sessions에 summary 추가 |
| 2025-07-08 | `20250708000000_add_base_branch_to_task_attempts.sql` | target_branch (구 base_branch) 추가 |
| 2025-07-09 | `20250709000000_add_worktree_deleted_flag.sql` | worktree_deleted 플래그 추가 |
| 2025-07-10 | `20250710000000_add_setup_completion.sql` | setup_completed_at 추가 |

**핵심 변경**:
- Git 브랜치 관리 (branch, target_branch)
- PR 추적 기능
- Worktree 라이프사이클 관리

---

### Phase 3: 템플릿 시스템 (2025-07-15 ~ 2025-07-20)

| 날짜 | 파일명 | 변경사항 |
|------|--------|----------|
| 2025-07-15 | `20250715154859_add_task_templates.sql` | task_templates 테이블 추가 |
| 2025-07-16 | `20250716143725_add_default_templates.sql` | 기본 템플릿 데이터 삽입 |
| 2025-07-16 | `20250716161432_update_executor_names_to_kebab_case.sql` | Executor 이름 kebab-case 변환 |
| 2025-07-16 | `20250716170000_add_parent_task_to_tasks.sql` | tasks에 parent_task_attempt 추가 (서브태스크) |
| 2025-07-17 | `20250717000000_drop_task_attempt_activities.sql` | task_attempt_activities 테이블 제거 |
| 2025-07-19 | `20250719000000_add_cleanup_script_to_projects.sql` | projects에 cleanup_script 추가 |
| 2025-07-20 | `20250720000000_add_cleanupscript_to_process_type_constraint.sql` | process_type에 'cleanupscript' 추가 |

**핵심 변경**:
- 템플릿 시스템 도입 (나중에 tags로 통합)
- 태스크 계층 구조 (parent_task_attempt)
- 구형 activities 테이블 제거

---

### Phase 4: 컨테이너 전환 (2025-07-26 ~ 2025-07-27)

| 날짜 | 파일명 | 변경사항 |
|------|--------|----------|
| 2025-07-26 | `20250726182144_update_worktree_path_to_container_ref.sql` | worktree_path → container_ref 리네임 |
| 2025-07-26 | `20250726210910_make_branch_optional.sql` | branch NULLABLE 변경 |
| 2025-07-27 | `20250727124142_remove_command_from_execution_process.sql` | execution_processes에서 command 제거 |
| 2025-07-27 | `20250727150349_remove_working_directory.sql` | working_directory 제거 |

**핵심 변경**:
- 클라우드 배포 준비 (worktree → container)
- 실행 프로세스 간소화

---

### Phase 5: 로그 시스템 (2025-07-29 ~ 2025-07-30)

| 날짜 | 파일명 | 변경사항 |
|------|--------|----------|
| 2025-07-29 | `20250729162941_create_execution_process_logs.sql` | execution_process_logs 테이블 추가 |
| 2025-07-29 | `20250729165913_remove_stdout_and_stderr_from_execution_processes.sql` | execution_processes에서 stdout/stderr 제거 |
| 2025-07-30 | `20250730000000_add_executor_action_to_execution_processes.sql` | executor_action (JSON) 추가 |
| 2025-07-30 | `20250730000001_rename_process_type_to_run_reason.sql` | process_type → run_reason 리네임 |
| 2025-07-30 | `20250730124500_add_execution_process_task_attempt_index.sql` | 인덱스 추가 |

**핵심 변경**:
- 로그를 별도 테이블로 분리 (JSONL 형식)
- executor_action으로 다형성 액션 지원
- 용어 정리 (process_type → run_reason)

---

### Phase 6: 액션 타입 (2025-08-05 ~ 2025-08-15)

| 날짜 | 파일명 | 변경사항 |
|------|--------|----------|
| 2025-08-05 | `20250805112332_add_executor_action_type_to_task_attempts.sql` | executor_action_type 가상 컬럼 추가 |
| 2025-08-05 | `20250805122100_fix_executor_action_type_virtual_column.sql` | 가상 컬럼 수정 |
| 2025-08-11 | `20250811000000_add_copy_files_to_projects.sql` | projects에 copy_files 추가 |
| 2025-08-13 | `20250813000001_rename_base_coding_agent_to_profile.sql` | base_coding_agent → profile 리네임 |
| 2025-08-15 | `20250815100344_migrate_old_executor_actions.sql` | 구형 executor_action 데이터 마이그레이션 |

**핵심 변경**:
- JSON 필드 추출 (가상 컬럼)
- 구형 데이터 마이그레이션

---

### Phase 7: 이미지 & 병합 리팩토링 (2025-08-18 ~ 2025-08-19)

| 날짜 | 파일명 | 변경사항 |
|------|--------|----------|
| 2025-08-18 | `20250818150000_refactor_images_to_junction_tables.sql` | images, task_images 테이블 추가 (M:N) |
| 2025-08-19 | `20250819000000_move_merge_commit_to_merges_table.sql` | merges 테이블 추가 (direct/PR 통합) |

**핵심 변경**:
- 이미지 시스템 완전 재설계 (Junction 테이블)
- 병합 정보를 별도 테이블로 분리
- task_attempts에서 merge_commit, PR 관련 컬럼 제거

**데이터 마이그레이션**:
```sql
-- task_attempts의 merge_commit → merges (direct)
INSERT INTO merges (id, task_attempt_id, merge_type, merge_commit, ...)
SELECT randomblob(16), id, 'direct', merge_commit, ...
FROM task_attempts
WHERE merge_commit IS NOT NULL;

-- task_attempts의 PR 정보 → merges (pr)
INSERT INTO merges (id, task_attempt_id, merge_type, pr_number, pr_url, ...)
SELECT randomblob(16), id, 'pr', pr_number, pr_url, ...
FROM task_attempts
WHERE pr_number IS NOT NULL;
```

---

### Phase 8: 프로세스 히스토리 추적 (2025-09-02 ~ 2025-09-10)

| 날짜 | 파일명 | 변경사항 |
|------|--------|----------|
| 2025-09-02 | `20250902120000_add_masked_by_restore_to_execution_processes.sql` | dropped 플래그 추가 (Soft delete) |
| 2025-09-02 | `20250902184501_rename-profile-to-executor.sql` | profile → executor 리네임 |
| 2025-09-03 | `20250903091032_executors_to_screaming_snake.sql` | Executor 이름 SCREAMING_SNAKE_CASE |
| 2025-09-05 | `20250905090000_add_after_head_commit_to_execution_processes.sql` | after_head_commit 추가 |
| 2025-09-06 | `20250906120000_add_follow_up_drafts.sql` | follow_up_drafts 테이블 추가 |
| 2025-09-10 | `20250910120000_add_before_head_commit_to_execution_processes.sql` | before_head_commit 추가 |

**핵심 변경**:
- Git commit tracking (before/after)
- Soft delete 지원 (dropped)
- Draft 시스템 도입

---

### Phase 9: 성능 최적화 (2025-09-17)

| 날짜 | 파일명 | 변경사항 |
|------|--------|----------|
| 2025-09-17 | `20250917123000_optimize_selects_and_cleanup_indexes.sql` | 복합 인덱스 추가, 중복 인덱스 제거 |

**추가된 인덱스**:
```sql
-- task_attempts: 태스크별 최신 시도 조회
CREATE INDEX idx_task_attempts_task_id_created_at
ON task_attempts (task_id, created_at DESC);

-- task_attempts: 전역 최신 시도 목록
CREATE INDEX idx_task_attempts_created_at
ON task_attempts (created_at DESC);

-- execution_processes: 시도별 실행 순서
CREATE INDEX idx_execution_processes_task_attempt_created_at
ON execution_processes (task_attempt_id, created_at ASC);

-- tasks: 프로젝트별 최신 태스크
CREATE INDEX idx_tasks_project_created_at
ON tasks (project_id, created_at DESC);
```

**제거된 인덱스**:
```sql
DROP INDEX idx_execution_processes_task_attempt_id;  -- 복합 인덱스로 대체됨
```

---

### Phase 10: Draft 통합 (2025-09-21)

| 날짜 | 파일명 | 변경사항 |
|------|--------|----------|
| 2025-09-21 | `20250921222241_unify_drafts_tables.sql` | follow_up_drafts + retry_drafts → drafts 통합 |

**변경사항**:
```sql
CREATE TABLE drafts (
    id                TEXT PRIMARY KEY,
    task_attempt_id   TEXT NOT NULL,
    draft_type        TEXT NOT NULL CHECK(draft_type IN ('follow_up', 'retry')),
    retry_process_id  TEXT NULL,
    prompt            TEXT NOT NULL DEFAULT '',
    queued            INTEGER NOT NULL DEFAULT 0,
    sending           INTEGER NOT NULL DEFAULT 0,
    version           INTEGER NOT NULL DEFAULT 0,
    variant           TEXT NULL,
    image_ids         TEXT NULL,
    created_at        DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at        DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(task_attempt_id, draft_type)
);

-- 기존 데이터 마이그레이션
INSERT INTO drafts (...)
SELECT ..., 'follow_up', ... FROM follow_up_drafts;

DROP TABLE follow_up_drafts;
```

**Trigger 추가**:
```sql
CREATE TRIGGER trg_drafts_updated_at
AFTER UPDATE ON drafts
FOR EACH ROW
BEGIN
    UPDATE drafts SET updated_at = CURRENT_TIMESTAMP WHERE id = OLD.id;
END;
```

---

### Phase 11: Branch 필수화 (2025-09-23)

| 날짜 | 파일명 | 변경사항 |
|------|--------|----------|
| 2025-09-23 | `20250923000000_make_branch_non_null.sql` | task_attempts.branch NOT NULL |

**변경사항**:
```sql
-- 기존 NULL 값을 빈 문자열로 채움
UPDATE task_attempts SET branch = '' WHERE branch IS NULL;

-- NOT NULL 제약 추가 (SQLite는 ALTER COLUMN 미지원이므로 재생성 필요)
-- 실제로는 애플리케이션 레벨에서 강제
```

---

### Phase 12: 템플릿 → 태그 (2025-10-20)

| 날짜 | 파일명 | 변경사항 |
|------|--------|----------|
| 2025-10-20 | `20251020120000_convert_templates_to_tags.sql` | task_templates → tags 변환 |

**변경사항**:
```sql
CREATE TABLE tags (
    id            BLOB PRIMARY KEY,
    tag_name      TEXT NOT NULL CHECK(INSTR(tag_name, ' ') = 0),
    content       TEXT NOT NULL CHECK(content != ''),
    created_at    TEXT NOT NULL DEFAULT (datetime('now', 'subsec')),
    updated_at    TEXT NOT NULL DEFAULT (datetime('now', 'subsec'))
);

-- 데이터 마이그레이션 (공백 → 언더스코어)
INSERT INTO tags (id, tag_name, content, created_at, updated_at)
SELECT
    id,
    LOWER(REPLACE(template_name, ' ', '_')) as tag_name,
    description,
    created_at,
    updated_at
FROM task_templates
WHERE description IS NOT NULL AND description != '';

-- 기존 테이블 제거
DROP TABLE task_templates;
```

**주요 변화**:
- 프로젝트별 템플릿 → 전역 태그로 단순화
- 공백 포함 이름 → snake_case 자동 변환
- 빈 description은 마이그레이션에서 제외

---

## Breaking Changes

### 1. task_attempt_activities 제거 (2025-07-17)
**영향**: 구형 상태 추적 제거
**마이그레이션**: execution_processes로 대체
**대응**: 애플리케이션 코드에서 activities 참조 제거

### 2. worktree_path → container_ref (2025-07-26)
**영향**: 컬럼명 변경
**마이그레이션**: 자동 리네임
**대응**: 코드에서 `worktree_path` → `container_ref` 변경

### 3. process_type → run_reason (2025-07-30)
**영향**: 컬럼명 변경
**마이그레이션**: 자동 리네임
**대응**: Enum 이름 변경

### 4. Merge 정보 분리 (2025-08-19)
**영향**: task_attempts에서 merge_commit, PR 컬럼 제거
**마이그레이션**: merges 테이블로 자동 이동
**대응**: `TaskAttempt.merge_commit` → `Merge::find_by_task_attempt_id()`

### 5. Images 리팩토링 (2025-08-18)
**영향**: 이미지 시스템 완전 재설계
**마이그레이션**: Junction 테이블 구조
**대응**: M:N 관계로 코드 변경

### 6. Drafts 통합 (2025-09-21)
**영향**: follow_up_drafts, retry_drafts 통합
**마이그레이션**: draft_type 필드로 구분
**대응**: 두 테이블 접근을 단일 테이블로 통합

### 7. Templates → Tags (2025-10-20)
**영향**: task_templates 제거
**마이그레이션**: tags로 변환 (프로젝트별 → 전역)
**대응**: 템플릿 시스템을 태그 시스템으로 변경

---

## 마이그레이션 패턴

### 1. 컬럼 추가 (NULLABLE)
```sql
ALTER TABLE table_name ADD COLUMN new_column TEXT;
```

### 2. 컬럼 추가 (DEFAULT 값)
```sql
ALTER TABLE table_name ADD COLUMN new_column TEXT DEFAULT 'default_value';
```

### 3. 컬럼 리네임
```sql
ALTER TABLE table_name RENAME COLUMN old_name TO new_name;
```

### 4. 테이블 재생성 (NOT NULL 추가 등)
SQLite는 제한적인 ALTER TABLE을 지원하므로 복잡한 변경은 재생성:
```sql
-- 1. 새 테이블 생성
CREATE TABLE new_table (...);

-- 2. 데이터 복사
INSERT INTO new_table SELECT ... FROM old_table;

-- 3. 기존 테이블 삭제
DROP TABLE old_table;

-- 4. 리네임
ALTER TABLE new_table RENAME TO old_table;
```

### 5. 데이터 마이그레이션
```sql
-- 기존 데이터 변환
INSERT INTO new_table (id, new_column, ...)
SELECT id, TRANSFORM(old_column), ...
FROM old_table;
```

---

## 향후 마이그레이션 가이드

### 새 마이그레이션 추가 시
1. `sqlx migrate add description` 실행
2. SQL 파일 작성 (PRAGMA foreign_keys 포함)
3. 로컬에서 테스트 (`sqlx migrate run`)
4. 코드 변경 사항 반영
5. 타입 생성 (`npm run generate-types`)
6. 테스트 실행

### 주의사항
- 기존 마이그레이션 절대 수정 금지
- 외래 키 제약 활성화 확인
- 데이터 손실 방지 (NULL 허용 또는 DEFAULT)
- CHECK 제약으로 데이터 무결성 보장
- 인덱스 추가 시 성능 영향 고려

---

## 참고 문서

- SQLx Migration Guide: https://github.com/launchbadge/sqlx/blob/main/sqlx-cli/README.md
- SQLite ALTER TABLE: https://www.sqlite.org/lang_altertable.html
- 프로젝트 개발 가이드: `/Users/cosmos/Documents/dev/any-on/CLAUDE.md`
