# Anyon 데이터베이스 스키마 개요

## 목차
1. [개요](#개요)
2. [데이터베이스 설계 철학](#데이터베이스-설계-철학)
3. [ERD (엔티티 관계도)](#erd-엔티티-관계도)
4. [테이블 목록](#테이블-목록)
5. [핵심 도메인 모델](#핵심-도메인-모델)

---

## 개요

**데이터베이스**: SQLite
**ORM/쿼리 빌더**: SQLx (compile-time checked queries)
**마이그레이션 관리**: SQLx migrations
**타입 시스템**: Rust structs + ts-rs (TypeScript 자동 생성)

Anyon은 AI 코딩 에이전트를 활용한 태스크 관리 시스템으로, Git worktree 기반의 독립적인 실행 환경을 제공합니다. 데이터베이스는 프로젝트, 태스크, 실행 프로세스, AI 세션 등의 복잡한 관계를 관리합니다.

---

## 데이터베이스 설계 철학

### 1. 이벤트 소싱 패턴
- **Execution Processes**: 모든 실행 이력을 시간순으로 저장
- **Process Logs**: JSONL 형식으로 로그 스트리밍 저장
- **Soft Delete**: `dropped` 플래그로 논리적 삭제 (히스토리 보존)

### 2. Git 통합
- **Commit Tracking**: `before_head_commit`, `after_head_commit`으로 변경사항 추적
- **Branch Management**: 각 TaskAttempt는 독립된 Git 브랜치 사용
- **Worktree Isolation**: `container_ref`로 격리된 작업 공간 관리

### 3. 다형성 데이터 모델
- **Merge**: Direct merge vs PR merge (discriminated union)
- **ExecutorAction**: JSON 저장으로 다양한 액션 타입 지원
- **Draft**: Follow-up vs Retry (단일 테이블에 type 필드로 구분)

### 4. 성능 최적화
- **복합 인덱스**: 자주 쿼리되는 조건 조합에 복합 인덱스 사용
- **Partial Index**: 조건부 인덱스 (예: `WHERE pr_status = 'open'`)
- **JSONL 로그**: 대용량 로그를 효율적으로 append

---

## ERD (엔티티 관계도)

```mermaid
erDiagram
    projects ||--o{ tasks : "has many"
    tasks ||--o{ task_attempts : "has many"
    tasks ||--o{ task_images : "has many"
    tasks ||--o| tasks : "parent_task_attempt (self-reference)"

    task_attempts ||--o{ execution_processes : "has many"
    task_attempts ||--o{ executor_sessions : "has many"
    task_attempts ||--o{ merges : "has many"
    task_attempts ||--o{ drafts : "has many"

    execution_processes ||--|| execution_process_logs : "has one"
    execution_processes ||--o{ executor_sessions : "has many"
    execution_processes ||--o{ drafts : "references (retry)"

    images ||--o{ task_images : "has many"

    projects {
        uuid id PK
        string name
        string git_repo_path UK
        string setup_script
        string dev_script
        string cleanup_script
        string copy_files
        datetime created_at
        datetime updated_at
    }

    tasks {
        uuid id PK
        uuid project_id FK
        string title
        string description
        enum status
        uuid parent_task_attempt FK
        datetime created_at
        datetime updated_at
    }

    task_attempts {
        uuid id PK
        uuid task_id FK
        string container_ref
        string branch
        string target_branch
        string executor
        boolean worktree_deleted
        datetime setup_completed_at
        datetime created_at
        datetime updated_at
    }

    execution_processes {
        uuid id PK
        uuid task_attempt_id FK
        enum run_reason
        json executor_action
        string before_head_commit
        string after_head_commit
        enum status
        integer exit_code
        boolean dropped
        datetime started_at
        datetime completed_at
        datetime created_at
        datetime updated_at
    }

    executor_sessions {
        uuid id PK
        uuid task_attempt_id FK
        uuid execution_process_id FK
        string session_id
        string prompt
        string summary
        datetime created_at
        datetime updated_at
    }

    execution_process_logs {
        uuid execution_id PK_FK
        string logs
        integer byte_size
        datetime inserted_at
    }

    merges {
        uuid id PK
        uuid task_attempt_id FK
        enum merge_type
        string merge_commit
        integer pr_number
        string pr_url
        enum pr_status
        datetime pr_merged_at
        string pr_merge_commit_sha
        string target_branch_name
        datetime created_at
    }

    drafts {
        uuid id PK
        uuid task_attempt_id FK
        enum draft_type
        uuid retry_process_id FK
        string prompt
        boolean queued
        boolean sending
        integer version
        string variant
        json image_ids
        datetime created_at
        datetime updated_at
    }

    images {
        uuid id PK
        string file_path
        string original_name
        string mime_type
        integer size_bytes
        string hash UK
        datetime created_at
        datetime updated_at
    }

    task_images {
        uuid id PK
        uuid task_id FK
        uuid image_id FK
        datetime created_at
    }

    tags {
        uuid id PK
        string tag_name
        string content
        datetime created_at
        datetime updated_at
    }
```

---

## 테이블 목록

### 핵심 도메인 테이블

| 테이블명 | 목적 | 주요 관계 |
|---------|------|----------|
| `projects` | Git 저장소 프로젝트 관리 | tasks의 부모 |
| `tasks` | 작업 항목 (이슈, 기능 요청 등) | project 소속, task_attempts 보유 |
| `task_attempts` | 태스크 실행 시도 (Git worktree 단위) | task 소속, execution_processes 보유 |
| `execution_processes` | 실행 프로세스 (setup, coding_agent, dev_server 등) | task_attempt 소속 |
| `executor_sessions` | AI 에이전트 세션 정보 | execution_process와 1:1 매핑 |

### 보조 테이블

| 테이블명 | 목적 | 특징 |
|---------|------|------|
| `execution_process_logs` | 프로세스 로그 (JSONL) | execution_processes와 1:1, append-only |
| `merges` | Git 병합 정보 (Direct/PR) | Polymorphic (merge_type) |
| `drafts` | 임시 프롬프트 저장 | Follow-up vs Retry 구분 |
| `images` | 이미지 파일 메타데이터 | SHA256 해시로 중복 제거 |
| `task_images` | Task-Image 연결 테이블 | Many-to-Many junction |
| `tags` | 재사용 가능한 태그/템플릿 | 전역 템플릿 시스템 |

---

## 핵심 도메인 모델

### 1. Project → Task → TaskAttempt 계층

```
Project (Git Repository)
  └── Task (Feature/Bug)
       └── TaskAttempt (Isolated Worktree)
            ├── ExecutionProcess (Setup)
            ├── ExecutionProcess (CodingAgent)
            ├── ExecutionProcess (DevServer)
            └── Merge (Direct or PR)
```

**특징**:
- 하나의 Task는 여러 TaskAttempt를 가질 수 있음 (재시도)
- 각 TaskAttempt는 독립된 Git worktree에서 실행
- ExecutionProcess는 시간순으로 실행 이력 저장

### 2. Execution Process 라이프사이클

```
ExecutionProcess 생성
  ├── status: 'running'
  ├── before_head_commit: 캡처
  ├── ExecutionProcessLogs: JSONL 스트리밍
  └── 완료 시
       ├── status: 'completed' | 'failed' | 'killed'
       ├── after_head_commit: 캡처
       └── exit_code: 종료 코드
```

### 3. AI 세션 추적

```
ExecutorSession
  ├── session_id: 외부 AI 서비스 세션 ID (Claude, Gemini 등)
  ├── prompt: 전송된 프롬프트
  └── summary: AI 응답 요약
```

### 4. Draft 시스템 (낙관적 UI)

```
Draft (Optimistic Updates)
  ├── draft_type: 'follow_up' | 'retry'
  ├── queued: 전송 대기 중
  ├── sending: 전송 중 (락)
  ├── version: 충돌 방지용 버전
  └── image_ids: 첨부 이미지 (JSON 배열)
```

**동시성 제어**:
- `queued` + `sending` 플래그로 이중 전송 방지
- `version` 필드로 낙관적 동시성 제어
- `UNIQUE(task_attempt_id, draft_type)` 제약

### 5. Merge 다형성

```
Merge (Discriminated Union)
  ├── merge_type: 'direct'
  │    └── merge_commit: SHA
  └── merge_type: 'pr'
       ├── pr_number: GitHub PR 번호
       ├── pr_url: PR URL
       ├── pr_status: 'open' | 'merged' | 'closed'
       └── pr_merge_commit_sha: 병합 커밋 (merged 시)
```

**CHECK 제약**:
```sql
CHECK (
    (merge_type = 'direct' AND merge_commit IS NOT NULL)
    OR
    (merge_type = 'pr' AND pr_number IS NOT NULL)
)
```

---

## 데이터 무결성

### Foreign Key 제약
- `PRAGMA foreign_keys = ON` 활성화
- 모든 외래 키에 `ON DELETE CASCADE` 적용
- 부모 레코드 삭제 시 자동으로 자식 레코드 정리

### Unique 제약
- `projects.git_repo_path`: 동일 저장소 중복 등록 방지
- `images.hash`: SHA256 해시로 중복 파일 방지
- `task_images(task_id, image_id)`: 중복 연결 방지
- `drafts(task_attempt_id, draft_type)`: Draft 타입별 1개만 허용

### Check 제약
- `tasks.status`: Enum 값 검증 ('todo', 'inprogress', 'done', 'cancelled', 'inreview')
- `execution_processes.status`: Enum 값 검증 ('running', 'completed', 'failed', 'killed')
- `merges`: merge_type별 필수 필드 검증
- `tags.tag_name`: 공백 금지 (`INSTR(tag_name, ' ') = 0`)
- `tags.content`: 빈 문자열 금지 (`content != ''`)

---

## 마이그레이션 히스토리 요약

**총 마이그레이션**: 46개 (2025-06-17 ~ 2025-10-20)

**주요 변경사항**:
1. **초기 스키마** (2025-06-17): projects, tasks, task_attempts, task_attempt_activities
2. **실행 추적** (2025-06-20): execution_processes, 로그 분리
3. **AI 세션** (2025-06-23): executor_sessions
4. **Git 통합** (2025-07-01): branch, pr_tracking
5. **로그 최적화** (2025-07-29): execution_process_logs (JSONL)
6. **이미지 시스템** (2025-08-18): images, task_images (junction)
7. **병합 추적** (2025-08-19): merges 테이블 (direct/PR 통합)
8. **Draft 통합** (2025-09-21): follow_up_drafts + retry_drafts → drafts
9. **성능 최적화** (2025-09-17): 복합 인덱스, 중복 인덱스 제거
10. **템플릿 → 태그** (2025-10-20): task_templates → tags

---

## 성능 고려사항

### 인덱스 전략
- **복합 인덱스**: `(외래키, 정렬 컬럼)` 패턴
- **Covering Index**: SELECT에 필요한 모든 컬럼 포함
- **Partial Index**: 조건부 쿼리 최적화

### 쿼리 패턴
- **JOIN 최소화**: 단일 테이블 쿼리 선호
- **가상 컬럼**: `executor_action_type` (JSON 필드 추출)
- **LEFT JOIN**: NULL 허용 관계

### 확장성
- **JSONL 로그**: 대용량 로그를 효율적으로 append
- **Soft Delete**: 히스토리 보존, 하드 삭제 지연
- **Cleanup 전략**: 72시간 이후 worktree 정리

---

## 다음 단계

상세한 정보는 다음 문서를 참조하세요:

- **[테이블상세.md](./테이블상세.md)**: 각 테이블의 컬럼 상세 설명
- **[마이그레이션이력.md](./마이그레이션이력.md)**: 전체 마이그레이션 타임라인
- **[쿼리패턴.md](./쿼리패턴.md)**: 자주 사용되는 쿼리 패턴
- **[인덱스전략.md](./인덱스전략.md)**: 인덱스 설계 및 최적화
