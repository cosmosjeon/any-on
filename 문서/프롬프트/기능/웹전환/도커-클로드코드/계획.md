## Phase 0 – Docker Transition POC Plan

### 0. Current Local Claude Pipeline (Reference)
- **Process launch** (`crates/local-deployment/src/container.rs:807`): `LocalContainerService::start_execution_inner` hands an `ExecutorAction` a host worktree path, then stores the spawned `AsyncGroupChild` handle and associates it with a `MsgStore`.
- **StdIO wiring** (`crates/local-deployment/src/container.rs:515`): `track_child_msgs_in_store` takes the child’s `stdout`/`stderr`, converts them into `LogMsg::{Stdout,Stderr}` streams, debounces them, and keeps them in memory for WebSocket streaming (`stream_raw_logs`).
- **Claude executor bridge** (`crates/executors/src/executors/claude.rs:214`): `ClaudeCode::spawn_internal` runs `npx @anthropic-ai/claude-code` with piped stdio, then uses `ProtocolPeer::spawn` to send prompts over stdin and parse streamed JSON from stdout/stderr.
- **Lifecycle & cleanup** (`crates/local-deployment/src/container.rs:274-420`): `spawn_exit_monitor` watches both the process exit status and executor-provided oneshot channel, writes completion metadata to the DB, commits/publishes diffs, and finally removes the child + log store.
- These behaviors set the bar for the Docker POC: we must prove that Bollard can provide equivalent stdin/out/err streaming, exit monitoring, and cleanup semantics so existing WebSocket/logging layers keep working.

### 1. Objective & Deliverables
- Prove that AnyOn workloads can run inside managed Docker containers without touching the existing LocalContainerService.
- Deliverables: `docker_poc.rs` test module, `anyon-claude` Docker image + README, `문서/프롬프트/기능/웹전환/도커-클로드코드/phase-0-poc-results.md`, passing cargo tests that cover Tasks 1–6.

### 2. Success Criteria
1. Rust code connects to the local Docker daemon via Bollard.
2. Containers can be created, started, monitored, and removed programmatically.
3. Claude Code CLI installs and runs (`claude --version`) inside the new image.
4. Streaming logs, long-running tasks, and enforced resource limits behave as expected.
5. POC documentation captures setup, results, and follow-on recommendations.

### 3. Assumptions / Preconditions
- Local Docker daemon is running and accessible without sudo.
- Internet access is available during Docker image build to install dependencies and Claude Code.
- Tokio + futures already part of the workspace; Bollard will be added to `crates/services` only.
- Tests run under `cargo test --package services docker_poc` to stay scoped.

### 4. Work Plan & Verification
#### Task 1 – Add Bollard & Basic Connectivity Test
1. Update `crates/services/Cargo.toml` with `bollard = { version = "0.17", features = ["tls"] }` (adjusted if TLS not needed).
2. Create `crates/services/src/services/docker_poc.rs`; wire module through `mod.rs`.
3. Implement `test_docker_basic` using Bollard `Docker::connect_with_local_defaults` and `version().await`.
4. Run `cargo test --package services docker_poc::tests::test_docker_basic -- --nocapture`.

#### Task 2 – Build Claude Code Docker Image
1. Add `docker/claude-code/Dockerfile` (Ubuntu 22.04 base, installs git/curl/vim/ca-certificates, adds Claude Code install script, sets `WORKDIR /workspace`).
2. Document build & usage in `docker/claude-code/README.md` (build command, run command, troubleshooting).
3. Execute `docker build -t anyon-claude:latest -f docker/claude-code/Dockerfile .`.
4. Validate with `docker run --rm anyon-claude:latest claude --version`.

#### Task 3 – Generic Container Lifecycle Test
1. Expand `docker_poc.rs` with helper utilities (e.g., `create_container`, `stream_logs`).
2. Test `ubuntu:22.04` container executing `echo hello` via `bollard::container::CreateContainerOptions`.
3. Attach to logs using Bollard streaming APIs (`logs`/`attach`) with both `stdout=true` and `stderr=true` to mirror `MsgStore` behavior; assert stdout contains `hello`.
4. Prove that we can read from the combined log stream without buffering the entire output (use `futures::StreamExt::next`).
5. Ensure `remove_container` runs even on failure (Drop guard or `tokio::runtime::Handle::current().spawn` cleanup).

#### Task 4 – Claude Code Execution Test
1. Add test creating container from `anyon-claude:latest` image.
2. Command: `claude --version`; capture stdout and assert it includes `Claude` or version string (ensure non-TTY mode so JSON logs stay machine-readable like current `ProtocolPeer` expectations).
3. Confirm image exists locally prior to running (build dependency from Task 2).
4. Record how long it takes to pull/start the container to feed POC doc.

#### Task 5 – Long-Running Job & Streaming
1. Implement async log streaming using Bollard `logs` API with `follow = true`, `stdin_open=true`, `attach_stdout/stderr=true` to emulate `MsgStore::history_plus_stream`.
2. Run `bash -c "for i in {5..1}; do echo $i; sleep 1; done"` inside an `ubuntu` container.
3. Assert timestamps or intervals roughly 1s apart (allow ±0.4s) to prove real-time streaming and record them for the doc.
4. Add cancellation test: stop container mid-run using `stop_container` (mirrors `command::kill_process_group`) and ensure logs receive a final `Finished` entry.
5. Bonus probe (optional if time permits): reuse the same container and send stdin input via `bollard::Docker::attach_container` to confirm we can drive `ProtocolPeer`-style conversations later.

#### Task 6 – Resource Limits Verification
1. When creating container, set `HostConfig { memory: Some(2 * 1024 * 1024 * 1024), nano_cpus: Some(1_000_000_000) }`.
2. After start, call `inspect_container` and confirm limits are applied.
3. (Optional) Run stress command to ensure throttling (record observations in docs).

#### Task 7 – Documentation & Reporting
1. Create `문서/프롬프트/기능/웹전환/도커-클로드코드/phase-0-poc-results.md` capturing environment, commands, timings, pass/fail matrix, issues & mitigations, readiness for Phase 1 (all Phase 0 artifacts now live under this directory).
2. Note any blockers (Docker perms, Claude installer) and recommended follow-ups (caching images, secrets handling).

### 5. Validation Checklist
- [ ] `cargo test --package services docker_poc` fully passing.
- [ ] `docker build ...` succeeds; image tagged `anyon-claude:latest`.
- [ ] Manual `docker run` version check succeeds.
- [ ] Streaming test shows sequential outputs and supports forced stop.
- [ ] Resource limits confirmed via inspect output.
- [ ] Documentation committed alongside code and stored under `문서/프롬프트/기능/웹전환/도커-클로드코드`.

### 6. Risk Mitigation
- **Docker access issues**: fallback instructions (restart daemon, add user to `docker` group) documented in README.
- **Claude installer drift**: pin installer URL/version, add checksum if provided.
- **Flaky timing asserts**: use generous tolerances and per-test timeouts.
- **Leftover containers**: implement shared cleanup helper with `tokio::time::timeout` to avoid dangling resources.

### 7. Next-Step Preview (Phase 1)
- Promote POC helpers into `CloudContainerService` abstraction.
- Implement trait compatibility with `LocalContainerService`.
- Integrate log streams with existing WebSocket broadcaster.
