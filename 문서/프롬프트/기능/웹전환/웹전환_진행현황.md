# 웹 전환 미션 중간 점검 & 상세 실행 계획 (2025-02-XX)

## 1. 전체 요약
- **Phase 3 (Claude 인증)**: 착수 전. 사용자/토큰 스키마와 디바이스 플로우 설계가 필요.
- **Phase 4 (GitHub 연동)**: API와 UI의 골격은 생겼지만, 토큰 저장/보안·Docker 연동이 미완.
- **Phase 5 (CloudDeployment)**: `CloudDeployment`는 여전히 Local 래퍼 수준. Bollard 기반 컨테이너 실행, 비밀 주입, 로그/정리 절차가 없음.

## 2. 현재 기능/문제 정리
| 영역 | 현재 상태 | 문제점 |
| --- | --- | --- |
| GitHub 인증 | 디바이스 플로우 API/모달 존재, config.json에 토큰 저장 | cloud 배포 시 파일 권한/보안 취약, Docker에서 토큰 사용 경로 없음 |
| GitHub Import UI | `/api/github/repositories`, `/api/projects/from-github` + UI 구현 | cloud feature 한정, 토큰 만료/오류 안내 부족 |
| Claude 인증 | 기능 없음 | CLI 디바이스 플로우를 웹에서 구현해야 함 (참고: [aifactory 포럼 글](https://aifactory.space/page/claude/forum/discussion/4543)) |
| Container 실행 | LocalContainerService만 존재 | Docker 환경에서 GitHub/Claude 비밀 주입, 설치 스크립트, 정리 루틴 없음 |
| 저장소/보안 | config.json에 모든 토큰 저장 | multi-user/보안 요구 충족 불가, 암호화 컬럼 필요 |

## 3. 즉시 수행할 일 (세부 과제)
### 3.1 GitHub 인증 정비 (최우선)
1. **Config → Secret Store 전환 설계**: 현재 GitHub OAuth/PAT은 dev_assets 기반 `config.json`에 저장된다. 먼저 `Config` 구조/`shared/types.ts`/프런트 설정 저장 경로를 DB(or SecretProvider) 기반으로 교체할지 결정하고, AES-GCM 키 생성·보관·로테이션 전략을 문서화한다. 단순히 암호화 컬럼을 추가하는 것이 아니라 Config load/save 파이프라인 전체를 대체해야 함을 명시한다.
2. **저장 매체 구현 & 마이그레이션**: `users` 또는 `secrets` 테이블과 키-관리 헬퍼를 추가하고, 서버 기동 시 기존 config.json → DB 이전/백업 스크립트를 제공한다. SQLite를 그대로 사용할 경우 파일 권한·경로가 config.json과 동일하므로, 키를 OS 비밀(예: systemd env)로 분리하여 저장 이점을 확보한다.
3. **Device Flow 동시성 해결**: `AuthService`가 전역 `device_codes` 1개만 들고 있는 구조를 세션/사용자 기준으로 확장하고, Cloud 다중 로그인 시 race condition이 없도록 저장 위치를 DB나 in-memory map keyed by session으로 바꾼다.
4. **cloud 환경 검증**: 디바이스 플로우 → 비밀 저장 → `/api/github/repositories` → `/api/projects/from-github` → 프로젝트 생성까지 cloud feature flag가 켜진 상태로 엔드투엔드 테스트.
5. **오류/만료 UX + Feature Gate**: `githubTokenInvalid` 상태를 General Settings/ProjectFormDialog에 노출하고, cloud build가 아닐 때는 GitHub import UI를 감추거나 비활성화한다. 만료 감지 시 다이얼로그로 재로그인을 유도한다.
6. **Docker 주입 설계**: CloudContainerService가 private repo clone 혹은 git fetch 시 토큰을 전달하는 방식(credential helper script, env var 등)을 문서화하고, 사용 후 파기 절차까지 정의한다.

### 3.2 Claude 디바이스 플로우 구현 (참고: [aifactory 사례](https://aifactory.space/page/claude/forum/discussion/4543))
1. **백엔드 API + 저장소 정의**: `/api/auth/claude/*` 전 엔드포인트를 추가하되, 플로우는 실제 Claude Code CLI 방식(사용자가 터미널에서 로그인 방법을 고르면 브라우저 OAuth 창이 열리고 승인만 하면 토큰이 교환되는 흐름)을 그대로 따른다. 저장 위치는 GitHub과 동일한 SecretProvider로 통합해 관리/암호화 정책을 공유하고, AuthService는 Anthropic OAuth state를 다중 사용자 기반으로 추적한다.
2. **Executor 통합 계획**: 현재 Claude executor는 호스트의 `~/.claude.json`을 읽는다. CLI 옵션 혹은 `CLAUDE_CONFIG_PATH` 같은 환경 변수로 컨테이너 내 임시 파일을 바라보도록 리팩터링하고, CLI가 host 홈 디렉터리에만 접근한다는 가정(디폴트)을 제거한다.
3. **CLI 브릿지 & 컨테이너 주입 시나리오**:
   - CloudContainerService가 작업 컨테이너를 준비할 때 `docker exec`/`exec start`를 이용해 비밀 파일을 `/tmp/claude-config.json` 같은 경로에 쓰고 권한을 600으로 제한한다.
   - executor 프로세스는 `CLAUDE_CONFIG_PATH` env로 해당 파일을 읽도록 하고, 실행 직후 shred/remove 하거나 컨테이너 삭제 전에 정리하는 훅을 만든다.
   - CLI 설치 여부 확인(`claude --version`), 실패 시 즉시 알람.
   - 프런트에서 버튼을 누르면 서버가 컨테이너 안에서 Claude CLI를 로그인 대기 상태로 실행하고, CLI가 출력하는 선택지/지침을 API로 스트리밍하여 UI에 표시한다. 사용자가 UI에서 옵션을 고르면 해당 입력을 CLI stdin으로 전달해 “1. Claude account” 같은 과정을 터미널 없이 재현한다.
4. **프런트 UI**: General Settings > Integrations 섹션에 Claude 로그인 카드 + NiceModal을 추가해, aifactory 사례와 동일한 단계(로그인 방법 선택, 브라우저 승인, 성공 상태)를 시각적으로 안내한다. CLI 출력(배너/텍스트)은 스트리밍으로 보여 주고, “로그인 방법 선택” UI가 CLI에 입력을 전달하도록 연결한다. cloud build에서만 노출하며, 완료 후에는 `console.anthropic.com` 승인 화면으로 자동 리다이렉트/팝업을 연다.
5. **모니터링/만료 대응**: Claude 토큰 만료/Anthropic API 오류를 이벤트 로거에 기록하고, 사용자에게 재로그인을 안내하는 배너/토스트를 추가한다.

### 3.3 CloudContainerService 실행 개선
1. **실제 실행 경로 전환**: 현재 CloudContainerService는 컨테이너만 띄우고 실행은 LocalContainerService가 호스트에서 수행한다. executor 실행을 docker exec 기반으로 옮기고, stdout/stderr/승인 흐름을 MsgStore에 그대로 흘려보내기 위한 어댑터를 설계한다.
2. **프로세스 생명주기 관리**: 컨테이너 안에서 실행된 프로세스를 추적할 수 있도록 exec ID ↔ task_attempt 매핑을 저장하고, 강제 종료 시 `docker kill` + `docker exec --signal` 조합을 사용한다.
3. **비밀 주입 흐름 구체화**: GitHub/Claude 토큰을 컨테이너에 전달할 때, 컨테이너가 살아있는 동안만 mount되는 tmpfs 혹은 `docker cp` + `chmod 600` 패턴을 문서화한다. 사용 후 삭제 여부를 확인하는 통합 테스트를 작성한다.
4. **이미지/런타임 표준화**: `anyon-claude` 이미지에 CLI, git, 빌드 의존성을 포함하고 버전을 `CloudContainerSettings`에서 관리한다. 이미지 미존재 시 CI에서 빌드하도록 체크리스트화.
5. **워크스페이스/보안**: `/var/opt/anyon/workspaces/<attempt>` 볼륨 마운트 정책을 확정하고, 컨테이너 유저를 비-루트로 설정하며 로그 스트림에서 비밀 문자열을 마스킹한다.

### 3.4 문서/테스트 보강
1. **문서**: `docs/DEPLOYMENT.md`, `USER_GUIDE.md`에 GitHub import & Claude 디바이스 플로우 절차, 환경 변수, 문제 해결 가이드 추가.
2. **테스트**: `/api/github/repositories`, `/api/projects/from-github`, `/api/auth/claude/*`에 대한 smoke 테스트 + Docker 실행 통합 테스트 설계.

## 4. 권장 로드맵 (상세)
| 기간 | 목표 | 주요 작업 |
| --- | --- | --- |
| 1주차 | GitHub 연동 다듬기 | DB 암호화 컬럼 도입, config → DB 마이그레이션, cloud E2E 테스트, 오류 UX 개선, Docker clone 임시 방안 |
| 2주차 | Claude 디바이스 플로우 구현 | `/api/auth/claude/*` API, UI/모달, 토큰 저장, 컨테이너 인증 자동화, 로그/알림 |
| 3~4주차 | CloudContainerService 구축 | Bollard 기반 실행, 이미지 준비, 비밀 주입/정리, 워크스페이스/보안 정책 |
| 5주차 | 통합 테스트 & 문서화 | GitHub+Claude+Docker 시나리오 테스트, 체크리스트, 운영 문서 업데이트 |

## 5. 아키텍처 점검 포인트
1. **저장소 계층**: config JSON 의존을 줄이고, 암호화된 DB 컬럼/Secret storage로 이전.
2. **Secret 관리**: 암호화 키 로테이션, 접근 제어, 감사 로그 정책 필요.
3. **컨테이너 경계**: GitHub/Claude 토큰이 컨테이너 밖으로 새지 않도록 환경 변수/파일 수명 관리.
4. **로그 정책**: 민감 값은 마스킹, 디바이스 플로우 이벤트는 감사 가능한 형태로 저장.
5. **Failover 전략**: 토큰 만료/Anthropic API 장애 시 사용자 안내 및 재시도 정책.

## 6. 참고 링크
- Claude 디바이스 플로우 CLI 예시: [aifactory.space 글](https://aifactory.space/page/claude/forum/discussion/4543)
- Anthropic 공식 문서: https://docs.anthropic.com/en/docs/claude-code/overview#install-and-authenticate

이 문서를 기반으로 다음 AI/엔지니어가 그대로 작업을 이어갈 수 있도록, 각 단계의 산출물(마이그레이션, API 명세, UI 시안, 컨테이너 스크립트)을 ticket 단위로 쪼개어 이행하세요.
